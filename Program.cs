using System;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using k8s;
using McMaster.Extensions.CommandLineUtils;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json.Linq;

namespace Container.Vulnerability.Agent
{
    class Program
    {
        static int Main(string[] args)
        {
            var app = new CommandLineApplication();

            app.HelpOption();

            var proxyHost = app.Option<string>(
                "--kubeProxy <URL>",
                "Kubernetes api proxy address (example http://127.0.0.1:8001). If address is not defined tool excepts to be running inside of pod in cluster.",
                CommandOptionType.SingleOrNoValue);

            var apiUri = app.Option<string>("--scannerApi <API_URL>", "Uri of scanner api. If left empty agent prints what it should send to api if defined.", CommandOptionType.SingleOrNoValue);

            var meta = app.Option<string>("--meta <META>", "", CommandOptionType.SingleOrNoValue);

            app.OnExecute(async () =>
            {
                var config =  GetConfig(proxyHost);
                var client = new Kubernetes(config);
                var pods = await client.ListPodForAllNamespacesAsync();

                var images = pods.Items
                    .SelectMany(x => x.Spec.Containers)
                    .Select(x => x.Image)
                    .Where(x => !x.Contains("/google_containers/") && !x.Contains("/google-containers/"))
                    .Distinct();

                var callBody = new
                {
                    Meta = meta.Value(),
                    Images = images
                };

                if(apiUri.HasValue())
                {
                }
                else
                {
                    Console.WriteLine("Api uri not set: sending data ignored.");
                    Console.WriteLine(JObject.FromObject(callBody));
                }

                return 0;
            });

            return app.Execute(args);
        }

        private static KubernetesClientConfiguration GetConfig(CommandOption proxyHost)
        {
            if(proxyHost.HasValue() && !string.IsNullOrEmpty(proxyHost.Value()))
                return new KubernetesClientConfiguration { Host = proxyHost.Value() };

            Console.WriteLine($"Proxy not set, using {nameof(KubernetesClientConfiguration.InClusterConfig)}");
            return KubernetesClientConfiguration.InClusterConfig();
        }
    }
}
